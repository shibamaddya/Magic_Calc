<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Secret Vault â€” Media, Files & Apps</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg1: #060311;
      --bg2: #180b3a;
      --card: rgba(255, 255, 255, 0.06);
      --accent: #9b6bff;
      --accent-hover: #b48eff;
      --border: rgba(255, 255, 255, 0.1);
      --text-muted: rgba(255, 255, 255, 0.6);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, var(--bg1), var(--bg2));
      background-attachment: fixed;
      color: #fff;
    }

    .wrap {
      min-height: 100vh; display: flex; flex-direction: column;
      gap: 20px; align-items: center; padding: 20px;
      max-width: 1400px; margin: 0 auto;
    }

    header {
      width: 100%; display: flex; justify-content: space-between;
      align-items: center; flex-wrap: wrap; gap: 15px;
    }

    h1 {
      font-size: clamp(20px, 4vw, 24px); font-weight: 700; margin: 0;
      background: linear-gradient(90deg, #fff, var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    /* Inputs & Buttons */
    button, input, select {
      background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border);
      color: #fff; padding: 10px 14px; border-radius: 8px;
      font-size: 14px; transition: 0.2s; font-family: inherit;
    }
    
    button { cursor: pointer; font-weight: 600; user-select: none; }
    button:active { transform: scale(0.96); }
    button:hover, input:focus { border-color: var(--accent); outline: none; background: rgba(255,255,255,0.08); }
    
    .btn-danger { color: #ff6b6b; border-color: rgba(255, 107, 107, 0.3); }
    .btn-danger:hover { background: rgba(255, 107, 107, 0.1); }

    .card {
      background: var(--card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      padding: 24px; border-radius: 16px; width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); border: 1px solid var(--border);
    }

    .inputs { display: flex; flex-direction: column; gap: 16px; }

    /* Drop Zone */
    .file-drop {
      border: 2px dashed var(--border); padding: 24px; border-radius: 12px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 12px; text-align: center; transition: 0.2s; cursor: pointer;
      background: rgba(0,0,0,0.2);
    }
    .file-drop:hover, .file-drop.dragover { border-color: var(--accent); background: rgba(155, 107, 255, 0.05); }

    .input-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .input-group input { flex: 1; min-width: 150px; }

    /* Gallery Grid */
    .gallery {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px; margin-top: 24px;
    }
    @media (min-width: 768px) { .gallery { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); } }

    .tile {
      background: rgba(255, 255, 255, 0.03); border-radius: 12px;
      padding: 10px; display: flex; flex-direction: column; gap: 10px;
      border: 1px solid transparent; transition: 0.2s; position: relative;
    }
    .tile:hover { border-color: var(--border); background: rgba(255, 255, 255, 0.06); transform: translateY(-2px); }

    .media-box {
      width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 8px;
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      cursor: pointer; position: relative;
    }
    .media-box img, .media-box video { width: 100%; height: 100%; object-fit: cover; }
    .media-box iframe { width: 100%; height: 100%; border: none; pointer-events: none; }
    
    .type-badge {
      position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.7);
      padding: 2px 6px; border-radius: 4px; font-size: 10px; text-transform: uppercase;
      font-weight: bold; pointer-events: none;
    }

    .meta input { 
      width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--border);
      padding: 4px 0; border-radius: 0; font-size: 13px; color: #eee;
    }
    .meta input:focus { border-color: var(--accent); background: transparent; }

    .actions { display: flex; gap: 6px; margin-top: auto; }
    .actions button { flex: 1; padding: 6px; font-size: 12px; }

    /* Apps Section */
    .apps { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .app-card {
      padding: 12px; border-radius: 10px; background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border); min-width: 140px; flex: 1;
      display: flex; flex-direction: column; gap: 8px;
    }
    .app-card h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000;
      display: none; align-items: center; justify-content: center; padding: 20px;
      flex-direction: column;
    }
    .modal.active { display: flex; animation: fadeIn 0.2s ease-out; }
    .modal-content { max-width: 100%; max-height: 85vh; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    .close-modal {
      position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1);
      border-radius: 50%; width: 40px; height: 40px; display: flex;
      align-items: center; justify-content: center; font-size: 24px; cursor: pointer;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--accent); color: #fff; padding: 10px 20px; border-radius: 30px;
      font-size: 14px; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    
    .loading { text-align: center; padding: 20px; color: var(--text-muted); font-size: 14px; }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>Secret Vault</h1>
    <div class="controls">
      <div id="clock" style="font-family: monospace; opacity: 0.8">00:00</div>
      <select id="sortSelect">
        <option value="new">Newest First</option>
        <option value="old">Oldest First</option>
        <option value="az">Name Aâ€“Z</option>
      </select>
      <button onclick="db.clear()" class="btn-danger">Reset Vault</button>
    </div>
  </header>

  <div class="card">
    <div id="storageInfo" style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">Calculated Storage...</div>

    <div class="inputs">
      <label class="file-drop" id="dropZone">
        <div style="font-size: 16px; font-weight: 600;">Tap to Select or Drop Files</div>
        <div style="font-size: 12px; opacity: 0.7;">Images, Videos, PDFs supported. No size limit (Device Storage).</div>
        <input id="fileInput" type="file" multiple style="display:none" />
        <button type="button" onclick="document.getElementById('fileInput').click()">Browse Files</button>
      </label>

      <div class="input-group">
        <input id="urlInput" type="url" placeholder="Paste URL (Image/YouTube/Web)" />
        <input id="tagInput" type="text" placeholder="Tags (optional)" style="flex: 0.5" />
        <button id="addUrlBtn">Add URL</button>
      </div>

      <div class="input-group">
        <input id="appName" type="text" placeholder="App Name" />
        <input id="appUrl" type="url" placeholder="https://..." />
        <button id="addAppBtn">Save App</button>
      </div>
      
      <div class="input-group" style="margin-top: 10px;">
         <input id="filterText" type="text" placeholder="Search files, tags..." style="background: rgba(0,0,0,0.2);" />
      </div>
    </div>

    <div id="appsContainer" style="margin-top: 30px; display: none;">
      <h3 style="font-size: 16px; margin-bottom: 10px; opacity: 0.8;">Quick Apps</h3>
      <div id="appsList" class="apps"></div>
    </div>

    <h3 style="font-size: 16px; margin-top: 30px; margin-bottom: 0; opacity: 0.8;">File Gallery</h3>
    <div id="gallery" class="gallery"></div>
    <div id="loading" class="loading" style="display:none">Loading...</div>
  </div>
  
  <footer style="font-size: 12px; opacity: 0.5; text-align: center;">
    Data is stored locally in your browser (IndexedDB). Clearing browser data deletes this vault.
  </footer>
</div>

<div id="modal" class="modal">
  <div class="close-modal" onclick="closeModal()">&times;</div>
  <img id="modalImg" class="modal-content" style="display:none" />
  <video id="modalVid" class="modal-content" controls style="display:none"></video>
  <iframe id="modalFrame" class="modal-content" style="display:none; width: 90vw; height: 80vh; background: #fff;"></iframe>
</div>

<div id="toast" class="toast">Action Successful</div>

<script>
// --- 1. IndexedDB Wrapper (The Fix for Storage Limits) ---
const DB_NAME = 'SecretVaultDB';
const STORE_FILES = 'files';
const STORE_APPS = 'apps';
const DB_VERSION = 1;

const db = {
  instance: null,
  async init() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains(STORE_FILES)) d.createObjectStore(STORE_FILES, { keyPath: 'id' });
        if (!d.objectStoreNames.contains(STORE_APPS)) d.createObjectStore(STORE_APPS, { keyPath: 'id' });
      };
      req.onsuccess = (e) => { this.instance = e.target.result; resolve(); };
      req.onerror = (e) => reject(e);
    });
  },
  async add(store, item) {
    return new Promise((resolve, reject) => {
      const tx = this.instance.transaction([store], 'readwrite');
      const req = tx.objectStore(store).add(item);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  },
  async getAll(store) {
    return new Promise((resolve) => {
      const tx = this.instance.transaction([store], 'readonly');
      const req = tx.objectStore(store).getAll();
      req.onsuccess = () => resolve(req.result || []);
    });
  },
  async delete(store, id) {
    return new Promise((resolve) => {
      const tx = this.instance.transaction([store], 'readwrite');
      tx.objectStore(store).delete(id);
      tx.oncomplete = () => resolve();
    });
  },
  async update(store, item) {
    return new Promise((resolve) => {
      const tx = this.instance.transaction([store], 'readwrite');
      tx.objectStore(store).put(item);
      tx.oncomplete = () => resolve();
    });
  },
  async clear() {
    if(confirm("Permanently delete all files and apps?")) {
      const tx = this.instance.transaction([STORE_FILES, STORE_APPS], 'readwrite');
      tx.objectStore(STORE_FILES).clear();
      tx.objectStore(STORE_APPS).clear();
      tx.oncomplete = () => { ui.render(); ui.toast("Vault Reset"); };
    }
  }
};

// --- 2. Logic & UI ---
const ui = {
  items: [],
  apps: [],
  
  async load() {
    document.getElementById('loading').style.display = 'block';
    this.items = await db.getAll(STORE_FILES);
    this.apps = await db.getAll(STORE_APPS);
    document.getElementById('loading').style.display = 'none';
    this.render();
  },

  render() {
    const g = document.getElementById('gallery');
    const al = document.getElementById('appsList');
    const ac = document.getElementById('appsContainer');
    const filter = document.getElementById('filterText').value.toLowerCase();
    const sort = document.getElementById('sortSelect').value;
    
    g.innerHTML = ''; 
    al.innerHTML = '';

    // Sort Items
    let sorted = [...this.items];
    if (sort === 'new') sorted.sort((a,b) => b.created - a.created);
    if (sort === 'old') sorted.sort((a,b) => a.created - b.created);
    if (sort === 'az') sorted.sort((a,b) => a.name.localeCompare(b.name));

    // Filter Items
    const validItems = sorted.filter(i => 
      !filter || i.name.toLowerCase().includes(filter) || (i.tags && i.tags.join(' ').toLowerCase().includes(filter))
    );

    document.getElementById('storageInfo').textContent = `${this.items.length} files â€¢ ${this.apps.length} apps stored safely in IDB.`;

    // Render Files
    validItems.forEach(item => {
      const el = document.createElement('div');
      el.className = 'tile';
      
      let preview = '';
      let badge = 'FILE';
      
      if (item.type.startsWith('image')) {
        preview = `<img src="${item.data}" loading="lazy" alt="img">`;
        badge = 'IMG';
      } else if (item.type.startsWith('video')) {
        preview = `<video src="${item.data}#t=0.5" preload="metadata"></video>`;
        badge = 'VID';
      } else if (item.type === 'youtube') {
        preview = `<img src="https://img.youtube.com/vi/${item.ytId}/hqdefault.jpg" style="opacity:0.7"><div style="position:absolute;color:#fff;font-size:24px">â–¶</div>`;
        badge = 'YT';
      } else {
         preview = `<div style="font-size:30px;opacity:0.5">ðŸ“„</div>`;
         badge = 'LINK';
      }

      el.innerHTML = `
        <div class="media-box" onclick="ui.open('${item.id}')">
          ${preview}
          <div class="type-badge">${badge}</div>
        </div>
        <div class="meta">
          <input value="${item.name}" onchange="ui.rename('${item.id}', this.value)" placeholder="Name">
        </div>
        <div class="actions">
          <button onclick="ui.download('${item.id}')">Save</button>
          <button class="btn-danger" onclick="ui.remove('${item.id}', 'file')">Del</button>
        </div>
      `;
      g.appendChild(el);
    });

    // Render Apps
    if(this.apps.length > 0) ac.style.display = 'block';
    else ac.style.display = 'none';

    this.apps.forEach(app => {
      const el = document.createElement('div');
      el.className = 'app-card';
      el.innerHTML = `
        <h4>${app.name}</h4>
        <div style="font-size:11px;opacity:0.6; overflow:hidden; text-overflow:ellipsis">${app.url}</div>
        <div class="actions">
          <button onclick="window.open('${app.url}', '_blank')">Open</button>
          <button class="btn-danger" onclick="ui.remove('${app.id}', 'app')">Ã—</button>
        </div>
      `;
      al.appendChild(el);
    });
  },

  async addFile(file) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      const item = {
        id: crypto.randomUUID(),
        created: Date.now(),
        name: file.name,
        type: file.type,
        size: file.size,
        data: e.target.result, // DataURL
        tags: []
      };
      await db.add(STORE_FILES, item);
      this.items.push(item);
      this.render();
      this.toast('File Added');
    };
    reader.readAsDataURL(file);
  },

  async addUrl() {
    const url = document.getElementById('urlInput').value.trim();
    const tags = document.getElementById('tagInput').value.split(',').map(t=>t.trim());
    if(!url) return;

    let type = 'website';
    let ytId = null;

    // Smart Type Detection
    if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) type = 'image/url';
    else if (url.match(/\.(mp4|webm|ogg|mov)$/i)) type = 'video/url';
    else {
      const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
      if(ytMatch) { type = 'youtube'; ytId = ytMatch[1]; }
    }

    const item = {
      id: crypto.randomUUID(),
      created: Date.now(),
      name: type === 'youtube' ? 'YouTube Video' : 'Link Item',
      type: type,
      data: url,
      ytId: ytId,
      tags: tags
    };
    
    await db.add(STORE_FILES, item);
    this.items.unshift(item); // Add to local list immediately
    document.getElementById('urlInput').value = '';
    this.render();
  },

  async addApp() {
    const name = document.getElementById('appName').value.trim();
    const url = document.getElementById('appUrl').value.trim();
    if(!name || !url) return;
    
    const app = { id: crypto.randomUUID(), name, url };
    await db.add(STORE_APPS, app);
    this.apps.push(app);
    document.getElementById('appName').value = '';
    document.getElementById('appUrl').value = '';
    this.render();
  },

  async remove(id, type) {
    if(!confirm("Delete this?")) return;
    if(type === 'file') {
      await db.delete(STORE_FILES, id);
      this.items = this.items.filter(i => i.id !== id);
    } else {
      await db.delete(STORE_APPS, id);
      this.apps = this.apps.filter(a => a.id !== id);
    }
    this.render();
  },

  async rename(id, newName) {
    const item = this.items.find(i => i.id === id);
    if(item) {
      item.name = newName;
      await db.update(STORE_FILES, item);
    }
  },

  download(id) {
    const item = this.items.find(i => i.id === id);
    if(!item) return;
    const a = document.createElement('a');
    a.href = item.data;
    a.download = item.name;
    a.click();
  },

  open(id) {
    const item = this.items.find(i => i.id === id);
    if(!item) return;
    
    const m = document.getElementById('modal');
    const mi = document.getElementById('modalImg');
    const mv = document.getElementById('modalVid');
    const mf = document.getElementById('modalFrame');

    mi.style.display = 'none'; mv.style.display = 'none'; mf.style.display = 'none';
    mv.pause(); mv.src = "";

    if(item.type.startsWith('image')) {
      mi.src = item.data; mi.style.display = 'block';
    } else if(item.type.startsWith('video')) {
      mv.src = item.data; mv.style.display = 'block';
    } else if(item.type === 'youtube') {
      mf.src = `https://www.youtube.com/embed/${item.ytId}?autoplay=1`;
      mf.style.display = 'block';
    } else {
      window.open(item.data, '_blank');
      return; 
    }
    m.classList.add('active');
  },

  toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }
};

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  document.getElementById('modalVid').pause();
  document.getElementById('modalFrame').src = ''; 
}

// --- 3. Events ---
window.addEventListener('DOMContentLoaded', async () => {
  await db.init();
  await ui.load();
  
  // Clock
  setInterval(() => {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }, 1000);

  // File Inputs
  const dz = document.getElementById('dropZone');
  const fi = document.getElementById('fileInput');

  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
  dz.addEventListener('dragleave', e => { dz.classList.remove('dragover'); });
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('dragover');
    [...e.dataTransfer.files].forEach(f => ui.addFile(f));
  });

  fi.addEventListener('change', e => {
    [...e.target.files].forEach(f => ui.addFile(f));
    fi.value = ''; 
  });

  document.getElementById('addUrlBtn').addEventListener('click', () => ui.addUrl());
  document.getElementById('addAppBtn').addEventListener('click', () => ui.addApp());
  document.getElementById('filterText').addEventListener('input', () => ui.render());
  document.getElementById('sortSelect').addEventListener('change', () => ui.render());
});

</script>
</body>
</html>